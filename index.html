<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Net Guard OS v17.0 - [Window Management Upgrade]</title>
    <style>
        :root {
            --color-bg: #0a0e27;
            --color-primary: #00ff88;
            --color-secondary: #00ccff; /* Blue for Cleared */
            --color-danger: #ff0066;   /* Red for Unlocked */
            --color-warning: #ffcc00;  /* Synergy & Minimize */
            --color-info: #8899ff;     /* Log Info */
            --color-locked: #444;       /* Locked Node */
            --color-grid-bg: #1a1a2e;
            --color-grid-border: #004466;
            --color-window-bg: rgba(26, 26, 46, 0.7);  
            --color-title-bar: rgba(0, 0, 0, 0.8);
            --color-menu-bg: rgba(10, 14, 39, 0.8);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-primary);
            overflow: hidden; height: 100vh; width: 100vw;
            user-select: none;  
        }
        #boot-screen, #log-console, #terminal-window, #terminal-input, .terminal-prompt {
            font-family: 'Courier New', monospace;
        }
        
        /* --- v10: Boot Screen --- */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: var(--color-primary);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000;
        }
        #boot-log { width: 80%; max-width: 600px; font-size: 1.1em; line-height: 1.8; }
        #boot-log p { margin: 0; }
        #login-prompt {
            margin-top: 20px; font-size: 1.2em; color: var(--color-warning);
            text-shadow: 0 0 10px var(--color-warning);
            animation: blink 1s step-end infinite;
        }
        .hidden { display: none !important; }
        @keyframes blink { 50% { opacity: 0; } }
        
        /* --- v4: Desktop Structure --- */
        #desktop-container { display: flex; height: 100vh; width: 100%; }
        #main-desktop-area {
            flex-grow: 1; height: 100%; position: relative;
            overflow: hidden; display: flex; flex-direction: column;
            background: var(--color-bg);
            transition: background-image 0.5s ease;
            cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 20 20'%3E%3Cpath fill='none' stroke='%2300ff88' stroke-width='1.5' d='M10 0v20M0 10h20M10 10m-3 0a3 3 0 1 1 6 0 3 3 0 0 1-6 0Z'/%3E%3C/svg%3E") 10 10, auto;
        }
        
        #matrix-canvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1; display: none;
        }
        
        #main-desktop-area.wallpaper-default::before {
            content: ""; position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; pointer-events: none;
            z-index: 2;
            background: repeating-linear-gradient(0deg, rgba(0, 255, 136, 0.02) 0px, rgba(0, 255, 136, 0.02) 1px, transparent 1px, transparent 3px);
            animation: scanmove 4s linear infinite;
        }
        #main-desktop-area.wallpaper-matrix::before { content: none; }
        @keyframes scanmove { 0% { background-position: 0 0; } 100% { background-position: 0 100px; } }
        
        /* --- v8: Desktop Icons --- */
        .desktop-icon-area { position: absolute; top: 20px; left: 20px; z-index: 10; }
        .desktop-icon {
            color: #fff; cursor: pointer; text-align: center;
            width: 100px; padding: 10px; border-radius: 5px;
            transition: background-color 0.2s;
            margin-bottom: 10px; font-size: 0.9em;
        }
        .desktop-icon:hover {
            background-color: rgba(0, 204, 255, 0.1);
            border: 1px solid rgba(0, 204, 255, 0.2);
        }
        .desktop-icon span { font-size: 2.5em; display: block; }
        .icon-svg {
            width: 40px; height: 40px; margin: 0 auto 5px auto;
            stroke-width: 1.5; stroke: var(--color-secondary); fill: none;
        }
        .desktop-icon:hover .icon-svg { stroke: var(--color-primary); }

        /* --- v8: Clock Widget --- */
        #clock-widget {
            position: absolute; top: 20px; right: 20px;
            font-size: 1.5em; color: var(--color-secondary);
            text-shadow: 0 0 10px var(--color-secondary);
            z-index: 10;
        }

        /* --- Log Console --- */
        #log-console {
            width: 350px; height: 100vh; background: #000;
            border-left: 2px solid var(--color-grid-border);
            display: flex; flex-direction: column; font-size: 0.9em;
            z-index: 2000;
        }
        #log-header {
            padding: 10px; font-weight: bold; color: var(--color-secondary);
            text-align: center; background: var(--color-title-bar);
            border-bottom: 1px solid var(--color-grid-border);
        }
        #log-content {
            flex-grow: 1; overflow-y: auto; padding: 10px;
            display: flex; flex-direction: column-reverse;
        }
        #log-content p { margin-bottom: 8px; line-height: 1.4; }
        .log-info { color: var(--color-info); }
        .log-success { color: var(--color-primary); }
        .log-error { color: var(--color-danger); }
        .log-warning { color: var(--color-warning); }
        .log-system { color: #888; font-style: italic; }

        /* --- Taskbar --- */
        #taskbar {
            width: 100%; height: 50px;  
            background: linear-gradient(0deg, #000 0%, #0A0A0A 100%);
            border-top: 1px solid var(--color-grid-border);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
            display: flex; align-items: center; padding: 0 10px;
            z-index: 500; margin-top: auto;
        }
        
        #start-btn {
            background: var(--color-primary); color: var(--color-bg); border: none;
            padding: 8px 10px; font-weight: bold; font-size: 1em;
            cursor: pointer; margin-right: 10px; border-radius: 3px;
        }
        #start-btn:hover { box-shadow: 0 0 10px var(--color-primary); }
        .icon-svg-small {
            width: 20px; height: 20px; stroke-width: 2;
            stroke: currentColor; fill: none;
            vertical-align: middle; margin-right: 5px;
        }
        /* v17: Small icon fix for buttons */
        .window-minimize .icon-svg-small, .window-maximize .icon-svg-small, .window-close .icon-svg-small {
            stroke: currentColor;
            width: 14px; height: 14px;
            stroke-width: 3;
            vertical-align: middle;
            margin: 0;
        }

        .taskbar-icon {
            font-family: inherit; font-size: 0.9em; font-weight: bold;
            padding: 8px 12px;  
            background: linear-gradient(0deg, #111 0%, #222 100%);
            border: 1px solid var(--color-grid-border);  
            border-radius: 3px; color: var(--color-secondary);
            cursor: pointer; margin-right: 10px; transition: all 0.2s;
        }
        .taskbar-icon:hover { background: var(--color-secondary); color: var(--color-bg); }
        .taskbar-icon.active { background: var(--color-primary); color: var(--color-bg); box-shadow: 0 0 10px var(--color-primary); border-color: var(--color-primary); }
        .taskbar-icon.minimized {
            background: var(--color-warning);  
            color: var(--color-bg);
            border-color: var(--color-warning);
        }
        
        #system-tray {
            margin-left: auto; display: flex; align-items: center;
        }
        .tray-icon {
            font-size: 1.1em; font-weight: bold; padding: 5px 8px;
            border: 1px solid transparent; color: #888;
            cursor: pointer; transition: all 0.3s;
        }
        .tray-icon .icon-svg-small { stroke: #888; }
        .tray-icon:hover .icon-svg-small { stroke: var(--color-primary); }
        @keyframes alert-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .tray-icon.alerting { animation: alert-blink 1s infinite; }
        .tray-icon.alerting .icon-svg-small { stroke: var(--color-danger); }
        
        /* --- v14: Window System --- */
        .window {
            position: absolute;
            top: 100px; left: 150px;
            width: 900px; height: 600px;  
            min-width: 400px; min-height: 300px;  
            background: var(--color-window-bg);  
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-grid-border);
            border-radius: 5px;
            z-index: 100; display: flex; flex-direction: column;
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
            transition: opacity 0.2s, top 0.2s ease-out, left 0.2s ease-out, width 0.2s ease-out, height 0.2s ease-out; /* v17: Add transitions */
        }
        .window.inactive { opacity: 0.8; border-color: #333; }
        
        /* v17: NEW Maximized State */
        .window.maximized {
            /* Calculate full size minus UI elements */
            top: 0 !important;
            left: 0 !important;
            width: calc(100vw - 350px) !important; /* Adjust for SYS-LOG width */
            height: calc(100vh - 50px) !important; /* Adjust for Taskbar height */
            border-radius: 0;
            transition-duration: 0.15s; /* Faster snap */
        }
        /* v17: Hide resize handle when maximized */
        .window.maximized .resize-handle {
            display: none;
        }
        
        #workshop-window { top: 5%; left: 10%; width: 900px; height: 600px; }
        #network-window { top: 10%; left: 15%; width: 800px; height: 600px; }
        #sys-mon-window { top: 15%; left: 20%; width: 400px; height: 450px; }
        #appearance-window { top: 20%; left: 25%; width: 400px; height: 300px; }
        #terminal-window { top: 25%; left: 30%; width: 600px; height: 400px; }
        #mail-window { top: 5%; left: 30%; width: 700px; height: 500px; }
        .window.hidden { display: none; }
        .window.minimized { display: none; }
        
        .title-bar {
            width: 100%; height: 30px;  
            background: var(--color-title-bar);
            border-bottom: 1px solid var(--color-grid-border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px;
            cursor: move;
        }
        .title-bar-text { color: var(--color-secondary); font-weight: bold; }
        .window-controls { display: flex; }
        /* v17: Added .window-maximize */
        .window-minimize, .window-maximize, .window-close {
            border: none;
            width: 22px; height: 22px;
            cursor: pointer;
            margin-left: 5px;
            line-height: 22px;  
            text-align: center;  
            background: var(--color-grid-bg);
            color: var(--color-warning);
            border-radius: 3px;
        }
        .window-close { background: var(--color-danger); color: #fff; }
        .window-maximize { color: var(--color-secondary); } /* v17: Different color */
        
        /* v17: NEW Icon switching for maximize/restore */
        .window .icon-restore { display: none; }
        .window.maximized .icon-maximize { display: none; }
        .window.maximized .icon-restore { display: inline-block; }

        
        .window-content {
            padding: 20px; flex-grow: 1; overflow-y: auto; overflow-x: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .resize-handle {
            position: absolute; width: 15px; height: 15px;
            bottom: 0; right: 0;
            cursor: se-resize;
            background: linear-gradient(135deg, transparent 50%, var(--color-grid-border) 50%, var(--color-grid-border) 70%, transparent 70%);
            opacity: 0.5; transition: opacity 0.2s;
            z-index: 10;
        }
        .window:hover .resize-handle { opacity: 1; }
        
        /* --- v14: Menu Animations --- */
        #context-menu, #start-menu {
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.15s ease-out, transform 0.15s ease-out;
            pointer-events: none;
        }
        #context-menu.visible, #start-menu.visible {
            opacity: 1; transform: translateY(0); pointer-events: auto;
        }
        
        /* --- v9: Context Menu --- */
        #context-menu {
            position: absolute; z-index: 9000;  
            background: var(--color-menu-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-grid-border);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            padding: 5px 0; border-radius: 3px;
        }
        #context-menu ul { list-style: none; }
        #context-menu li {
            padding: 8px 20px; color: var(--color-secondary);
            cursor: pointer; display: flex;
            align-items: center; font-size: 0.9em;
        }
        #context-menu li:hover { background-color: var(--color-secondary); color: var(--color-bg); }
        #context-menu li.disabled { color: #555; cursor: not-allowed; }
        #context-menu li.divider { height: 1px; background: var(--color-grid-border); margin: 5px 0; padding: 0; }
        
        /* --- v11: Start Menu --- */
        #start-menu {
            position: absolute; z-index: 499;  
            bottom: 50px; left: 0;
            background: var(--color-menu-bg);
            backdrop-filter: blur(10px);
            border: 2px solid var(--color-grid-border);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border-radius: 3px;
        }
        #start-menu ul { list-style: none; padding: 10px; }
        .start-menu-item {
            padding: 12px 20px; color: var(--color-secondary);
            cursor: pointer; width: 250px;
            display: flex; align-items: center; border-radius: 3px;
        }
        .start-menu-item:hover { background-color: var(--color-secondary); color: var(--color-bg); }
        .start-menu-item.divider { height: 1px; background: var(--color-grid-border); margin: 5px 0; padding: 0; }
        .start-menu-item.disabled { color: #555; cursor: not-allowed; }

        /* --- Core Builder Toolbar --- */
        .toolbar {
            width: 100%; padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px dashed var(--color-grid-border);
        }
        .toolbar-btn {
            background: var(--color-danger); color: #fff;
            border: 1px solid var(--color-danger);
            padding: 5px 10px; font-family: inherit;
            font-size: 0.9em; font-weight: bold;
            cursor: pointer; transition: all 0.2s; border-radius: 3px;
        }
        .toolbar-btn:hover {
            box-shadow: 0 0 10px var(--color-danger);
            background: #fff; color: var(--color-danger);
        }

        /* --- v14: Workshop Content (Flexbox Fix) --- */
        #workshop-view-content { display: flex; flex-wrap: wrap; gap: 20px; height: 100%; }
        fieldset { border: 1px solid var(--color-grid-border); padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        legend { color: var(--color-secondary); font-weight: bold; padding: 0 10px; margin-left: 5px; font-size: 1.1em; }
        .right-panels { display: flex; flex-direction: column; gap: 0; flex: 1 1 280px; min-width: 280px; }
        #grid-panel { display: flex; flex-direction: column; flex: 2 1 450px; min-width: 450px; }
        #grid-header { color: var(--color-secondary); font-size: 1.1em; margin-bottom: 10px; font-weight: bold; }
        .grid-layout-container { display: flex; }
        .grid-labels-y { display: flex; flex-direction: column; justify-content: space-around; padding-right: 10px; font-size: 0.8em; color: #666; }
        .grid-labels-x { display: flex; justify-content: space-around; padding-left: 25px; font-size: 0.8em; color: #666; }
        #grid-container {
            display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr);
            gap: 2px; background-color: var(--color-grid-border); border: 1px solid var(--color-secondary);
            width: 100%; aspect-ratio: 1 / 1; padding: 2px;
        }
        .grid-cell { width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.2); border: 1px solid var(--color-grid-border); cursor: pointer; transition: background-color 0.2s; }
        @keyframes module-pop-in { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .module-occupied { animation: module-pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid var(--color-primary); cursor: grabbing; }
        .module-cpu_core { background-color: #f0f; } .module-scanner_v1 { background-color: #0ff; }
        .module-firewall_v1 { background-color: #f80; } .module-firewall_v2 { background-color: #f00; }
        .preview-valid { background-color: rgba(0, 255, 136, 0.5) !important; }
        .preview-invalid { background-color: rgba(255, 0, 102, 0.5) !important; }
        #dashboard { font-size: 1.1em; } .stat-item { margin-bottom: 15px; }
        .stat-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 1.1em; }
        .stat-value { color: var(--color-secondary); font-weight: bold; }
        .stat-bonus { color: var(--color-warning); }
        .stat-bar-bg { width: 100%; height: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--color-grid-border); border-radius: 2px; overflow: hidden; }
        .stat-bar-fill { height: 100%; transition: width 0.4s ease-out; box-shadow: 0 0 10px; }
        .fill-Detection { background-color: var(--color-secondary); box-shadow: 0 0 10px var(--color-secondary); }
        .fill-Firewall { background-color: var(--color-danger); box-shadow: 0 0 10px var(--color-danger); }
        .fill-Memory { background-color: var(--color-warning); box-shadow: 0 0 10px var(--color-warning); }
        @keyframes stat-flash { 0% { text-shadow: 0 0 10px var(--color-warning); color: var(--color-warning); } 100% { text-shadow: none; color: var(--color-secondary); } }
        .stat-updated { animation: stat-flash 0.5s ease-out; }
        #inventory { max-height: 200px; overflow-y: auto; padding-right: 5px; }
        .inventory-item {
            font-family: inherit; display: flex; align-items: center;
            width: 100%; padding: 10px; margin-bottom: 8px; background-color: var(--color-bg);
            border: 1px solid var(--color-primary); color: var(--color-primary); font-size: 1em;
            cursor: pointer; transition: all 0.3s;
        }
        .inventory-item:hover { background-color: var(--color-primary); color: var(--color-bg); }
        .inventory-item:disabled { opacity: 0.3; cursor: not-allowed; background-color: #333; }
        .inventory-item.selected { background-color: var(--color-danger); border-color: var(--color-danger); color: #fff; }
        .module-preview { display: grid; margin-right: 10px; border: 1px solid var(--color-grid-border); }
        .preview-cell { width: 8px; height: 8px; }
        .preview-cell.filled { background-color: var(--color-info); }
        .inventory-item:hover .preview-cell.filled { background-color: var(--color-bg); }
        .inventory-item.selected .preview-cell.filled { background-color: #fff; }

        /* --- Network Map Styling --- */
        #map-container {
            width: 100%; height: 100%; position: relative;
            background-color: #0d122e; border: 1px solid var(--color-grid-border);
            border-radius: 4px; overflow: hidden;
            background-image: linear-gradient(rgba(0, 100, 150, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 100, 150, 0.1) 1px, transparent 1px), radial-gradient(ellipse at center, rgba(0, 100, 150, 0.05) 0%, transparent 70%);
            background-size: 50px 50px, 50px 50px, 100% 100%;
            background-position: 0 0, 0 0, 50% 50%;
            animation: map-flicker 10s infinite alternate;
        }
        @keyframes map-flicker { 0% { background-position: 0 0, 0 0, 50% 50%; opacity: 1; } 50% { opacity: 0.95; } 100% { background-position: 5px 5px, 5px 5px, 50% 50%; opacity: 1; } }
        #scanner-sweep {
            position: absolute; left: 50%; top: 50%; width: 0px; height: 0px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 204, 255, 0.5) 0%, rgba(0, 204, 255, 0) 70%);
            transform: translate(-50%, -50%) scale(0);
            animation: scanner-pulse 8s infinite cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 10; pointer-events: none;
        }
        @keyframes scanner-pulse { 0% { width: 0px; height: 0px; opacity: 0.8; transform: translate(-50%, -50%) scale(0); } 20% { opacity: 0.9; } 80% { opacity: 0; } 100% { width: 150%; height: 150%; opacity: 0; transform: translate(-50%, -50%) scale(1); } }
        #map-lines { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        .connection-line {
            position: absolute; height: 2px; background-color: var(--color-grid-border);
            opacity: 0.5; transform-origin: 0 50%; box-shadow: 0 0 5px rgba(0, 204, 255, 0.2);
        }
        .connection-line.unlocked { background-color: var(--color-danger); opacity: 0.7; box-shadow: 0 0 8px var(--color-danger); }
        #map-nodes { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 30; }
        .map-node {
            position: absolute; width: 20px; height: 20px; border-radius: 50%;
            cursor: pointer; pointer-events: all; transform: translate(-50%, -50%);
            transition: all 0.3s; display: flex; align-items: center; justify-content: center;
        }
        .map-node::after {
            content: attr(data-name); position: absolute; top: 100%; left: 50%;
            transform: translateX(-50%); margin-top: 5px; padding: 2px 5px;
            background: rgba(0,0,0,0.7); border-radius: 3px; font-size: 0.8em;
            white-space: nowrap; color: var(--color-primary);
            border: 1px solid var(--color-grid-border); opacity: 0; transition: opacity 0.2s;
        }
        .map-node:hover::after { opacity: 1; }
        .map-node.state-LOCKED { background: rgba(68, 68, 68, 0.3); border: 2px solid var(--color-locked); color: #888; box-shadow: 0 0 5px rgba(68, 68, 68, 0.5); }
        .map-node.state-UNLOCKED { background: rgba(255, 0, 102, 0.3); border: 2px solid var(--color-danger); color: var(--color-danger); animation: pulse-red 2s infinite; box-shadow: 0 0 15px var(--color-danger); }
        .map-node.state-CLEARED { background: rgba(0, 204, 255, 0.3); border: 2px solid var(--color-secondary); color: var(--color-secondary); box-shadow: 0 0 15px var(--color-secondary); }
        .map-node:hover { transform: translate(-50%, -50%) scale(1.3); }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 102, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 102, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 102, 0); } }
        #challenge-details-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: var(--color-window-bg); border-top: 2px solid var(--color-grid-border);
            padding: 15px; transform: translateY(100%); transition: transform 0.4s ease-out;
            z-index: 200; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        #challenge-details-panel.visible { transform: translateY(0%); }
        #details-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed var(--color-grid-border); padding-bottom: 10px; margin-bottom: 10px; }
        #details-title { font-size: 1.3em; color: var(--color-secondary); text-shadow: 0 0 5px var(--color-secondary); }
        #details-close-btn { background: none; border: 1px solid var(--color-danger); color: var(--color-danger); font-size: 1em; cursor: pointer; padding: 3px 8px; border-radius: 3px; transition: all 0.2s; }
        #details-close-btn:hover { background: var(--color-danger); color: #fff; box-shadow: 0 0 10px var(--color-danger); }
        #details-content { display: flex; gap: 20px; margin-top: 15px; }
        #details-left, #details-right { flex: 1; }
        #details-content h4 { color: var(--color-primary); margin-bottom: 5px; text-shadow: 0 0 3px var(--color-primary); }
        #details-content ul { list-style: none; padding-left: 0; margin-bottom: 15px; border-left: 2px solid rgba(0, 255, 136, 0.2); padding-left: 10px; }
        #details-reqs li { color: var(--color-secondary); margin-bottom: 3px;}
        #details-cons li { color: var(--color-warning); margin-bottom: 3px;}
        #details-try-btn {
            font-family: inherit; font-size: 1.1em; font-weight: bold;
            width: 100%; padding: 12px; background: var(--color-danger);
            border: none; color: var(--color-bg); cursor: pointer; transition: all 0.3s;
            margin-top: 10px; border-radius: 5px;
        }
        #details-try-btn:hover { box-shadow: 0 0 20px var(--color-danger); }
        #details-try-btn:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }
        
        /* --- v11: New App Styles --- */
        .chart-bar-bg {
            width: 100%; height: 20px; background: rgba(0,0,0,0.5);
            border: 1px solid var(--color-grid-border); border-radius: 2px;
            margin-bottom: 10px;
        }
        .chart-bar-fill {
            height: 100%; background: var(--color-warning);
            width: 0%; transition: width 0.4s ease;
        }
        .fake-chart {
            height: 100px; width: 100%;
            border: 1px solid var(--color-grid-border);
            background: rgba(0,0,0,0.3);
            overflow: hidden; position: relative;
        }
        .fake-chart-line {
            position: absolute; bottom: 0; left: -100%;
            width: 200%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,0,102,0.5), transparent);
            animation: move-line 4s linear infinite;
        }
        @keyframes move-line { 0% { transform: translateX(0%); } 100% { transform: translateX(50%); } }
        .theme-button {
            background: var(--color-grid-bg);
            border: 1px solid var(--color-secondary);
            color: var(--color-secondary);
            padding: 10px 15px; font-family: inherit;
            font-size: 1em; cursor: pointer;
            width: 100%; margin-bottom: 10px;
        }
        .theme-button:hover { background: var(--color-secondary); color: var(--color-bg); }
        .theme-button.active { background: var(--color-primary); color: var(--color-bg); border-color: var(--color-primary); }
        
        /* --- v13: Terminal App --- */
        #terminal-window .window-content {
            background: #000; padding: 10px;
            flex-grow: 1; display: flex; flex-direction: column;
        }
        #terminal-output { flex-grow: 1; overflow-y: auto; color: var(--color-primary); }
        #terminal-output p { white-space: pre-wrap; }
        .terminal-prompt-line { display: flex; }
        .terminal-prompt { color: var(--color-primary); margin-right: 5px; }
        #terminal-input {
            background: none; border: none;
            color: var(--color-primary);
            font-family: 'Courier New', monospace;
            font-size: 1em; flex-grow: 1;
        }
        #terminal-input:focus { outline: none; }
        
        /* --- v13: Mail App --- */
        #mail-window .window-content { padding: 0; flex-direction: row; }
        #mail-sidebar {
            width: 200px; background: rgba(0,0,0,0.2);
            border-right: 1px solid var(--color-grid-border);
            padding: 10px;
        }
        .mail-item {
            padding: 10px; border-bottom: 1px solid var(--color-grid-border);
            cursor: pointer;
        }
        .mail-item.active { background: var(--color-primary); color: var(--color-bg); }
        .mail-item-sender { font-weight: bold; }
        .mail-item-subject { font-size: 0.9em; opacity: 0.8; }
        
        #mail-reader { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .mail-header {
            border-bottom: 1px dashed var(--color-grid-border);
            padding-bottom: 15px; margin-bottom: 20px;
        }
        .mail-header h3 { color: var(--color-secondary); margin-bottom: 5px;}
        .mail-header p { font-size: 0.9em; color: #aaa; }
        .mail-body { font-size: 1.1em; line-height: 1.6; color: #eee; }

        /* --- Responsive Design --- */
        @media (max-width: 900px) {
            #desktop-container { flex-direction: column-reverse; }
            #log-console { width: 100%; height: 200px; border-left: none; border-top: 2px solid var(--color-grid-border); }
            #log-content { flex-direction: column; font-size: 0.8em; }
            #taskbar { margin-top: 0; }
            .window { width: 95% !important; height: 90% !important; max-height: none; top: 0 !important; left: 2.5% !important; }
            #workshop-view-content { grid-template-columns: 1fr; }
            .right-panels { margin-top: 20px; }
            .grid-layout-container { min-height: 300px; }
            h2 { font-size: 1.2em; }
            #details-content { flex-direction: column; }
            #mail-window .window-content { flex-direction: column; }
            #mail-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--color-grid-border); }
            
            /* v17: Adjust maximized state for mobile */
            .window.maximized {
                width: 95% !important;
                height: calc(100vh - 250px) !important; /* 100vh - log(200) - taskbar(50) */
                top: 0 !important;
                left: 2.5% !important;
            }
        }

    </style>
</head>
<body>

    <div id="boot-screen">
        <div id="boot-log"></div>
        <div id="login-prompt" class="hidden">[ PRESS ANY KEY TO LOGIN ]</div>
    </div>

    <div id="desktop-container" class="hidden">
        <div id="main-desktop-area" class="wallpaper-default">
            <canvas id="matrix-canvas"></canvas>
            
            <div id="clock-widget">00:00:00</div>

            <div class="desktop-icon-area">
                <div class="desktop-icon" data-window="workshop-window"> <span class="icon-svg"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /> </svg> </span> Core Builder </div>
                <div class="desktop-icon" data-window="network-window"> <span class="icon-svg"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" /> </svg> </span> Global Network </div>
                <div class="desktop-icon" data-window="sys-mon-window"> <span class="icon-svg"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /> </svg> </span> Sys Monitor </div>
                <div class="desktop-icon" data-window="appearance-window"> <span class="icon-svg"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /> </svg> </span> Appearance </div>
                <div class="desktop-icon" data-window="terminal-window"> <span class="icon-svg"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /> </svg> </span> Terminal </div>
                <div class="desktop-icon" data-window="mail-window"> <span class="icon-svg"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /> </svg> </span> Secure Mail </div>
            </div>

            <div id="workshop-window" class="window hidden">
                <div class="title-bar">
                    <span class="title-bar-text">‚öôÔ∏è Core Builder v3.1</span>
                    <div class="window-controls">
                        <button class="window-minimize" data-window="workshop-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12H4"/></svg></button>
                        <button class="window-maximize" data-window="workshop-window">
                            <svg class="icon-svg-small icon-maximize" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg>
                            <svg class="icon-svg-small icon-restore" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        </button>
                        <button class="window-close" data-window="workshop-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                    </div>
                </div>
                <div class="window-content">
                    <div class="toolbar"> <button id="clear-grid-btn" class="toolbar-btn">[ Clear Grid ]</button> </div>
                    <div id="workshop-view-content">
                        <div id="grid-panel"> <div id="grid-header">// BUILD_GRID (8x8)</div> <div class="grid-labels-x"></div> <div class="grid-layout-container"> <div class="grid-labels-y"></div> <div id="grid-container"></div> </div> </div>
                        <div class="right-panels"> <fieldset id="dashboard-panel"> <legend>// SYSTEM_STATS</legend> <div id="dashboard"></div> </fieldset> <fieldset id="inventory-panel"> <legend>// COMPONENT_BAY</legend> <div id="inventory"></div> </fieldset> </div>
                    </div>
                </div>
                <div class="resize-handle"></div>
            </div>

            <div id="network-window" class="window hidden">
                <div class="title-bar">
                    <span class="title-bar-text">üåç Global Network Intel</span>
                    <div class="window-controls">
                        <button class="window-minimize" data-window="network-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12H4"/></svg></button>
                        <button class="window-maximize" data-window="network-window">
                            <svg class="icon-svg-small icon-maximize" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg>
                            <svg class="icon-svg-small icon-restore" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        </button>
                        <button class="window-close" data-window="network-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                    </div>
                </div>
                <div class="window-content">
                    <div id="map-container"> <div id="scanner-sweep"></div> <div id="map-lines"></div> <div id="map-nodes"></div> </div>
                    <div id="challenge-details-panel">
                        <div id="details-header"> <h3 id="details-title">// NODE_NAME</h3> <button id="details-close-btn">[X]</button> </div>
                        <div id="details-content">
                            <div id="details-left"> <h4>Requirements:</h4> <ul id="details-reqs"></ul> </div>
                            <div id="details-right"> <h4>Constraints:</h4> <ul id="details-cons"></ul> <button id="details-try-btn" data-nodeid="">ATTEMPT HACK</button> </div>
                        </div>
                    </div>
                </div>
                <div class="resize-handle"></div>
            </div>
            
            <div id="sys-mon-window" class="window hidden">
                <div class="title-bar">
                    <span class="title-bar-text">üìà System Monitor</span>
                    <div class="window-controls">
                        <button class="window-minimize" data-window="sys-mon-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12H4"/></svg></button>
                        <button class="window-maximize" data-window="sys-mon-window">
                            <svg class="icon-svg-small icon-maximize" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg>
                            <svg class="icon-svg-small icon-restore" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        </button>
                        <button class="window-close" data-window="sys-mon-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                    </div>
                </div>
                <div class="window-content">
                    <fieldset> <legend>// CORE_MEMORY_USAGE</legend> <div class="stat-item"> <div class="stat-label"> <span>üíæ Memory</span> <span id="mem-usage-label" class="stat-value">0 / 0</span> </div> <div class="stat-bar-bg"> <div id="mem-usage-bar" class="stat-bar-fill fill-Memory" style="width: 0%;"></div> </div> </div> </fieldset>
                    <fieldset> <legend>// CPU_LOAD (simulated)</legend> <div class="fake-chart"> <div class="fake-chart-line" style="animation-delay: -1s; background: linear-gradient(90deg, transparent, var(--color-primary), transparent);"></div> </div> </fieldset>
                    <fieldset> <legend>// NETWORK_TRAFFIC (simulated)</legend> <div class="fake-chart"> <div class="fake-chart-line" style="animation-duration: 2s; background: linear-gradient(90deg, transparent, var(--color-danger), transparent);"></div> </div> </fieldset>
                </div>
                <div class="resize-handle"></div>
            </div>
            
            <div id="appearance-window" class="window hidden">
                <div class="title-bar">
                    <span class="title-bar-text">üé® Appearance</span>
                    <div class="window-controls">
                        <button class="window-minimize" data-window="appearance-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12H4"/></svg></button>
                        <button class="window-maximize" data-window="appearance-window">
                            <svg class="icon-svg-small icon-maximize" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg>
                            <svg class="icon-svg-small icon-restore" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        </button>
                        <button class="window-close" data-window="appearance-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                    </div>
                </div>
                <div class="window-content">
                    <fieldset> <legend>// DESKTOP_WALLPAPER</legend> <button id="btn-theme-default" class="theme-button active">Default (Cyber Blue)</button> <button id="btn-theme-matrix" class="theme-button">Matrix (Green)</button> </fieldset>
                </div>
                <div class="resize-handle"></div>
            </div>
            
            <div id="terminal-window" class="window hidden">
                <div class="title-bar">
                    <span class="title-bar-text">>_ Terminal</span>
                    <div class="window-controls">
                        <button class="window-minimize" data-window="terminal-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12H4"/></svg></button>
                        <button class="window-maximize" data-window="terminal-window">
                            <svg class="icon-svg-small icon-maximize" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg>
                            <svg class="icon-svg-small icon-restore" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        </button>
                        <button class="window-close" data-window="terminal-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                    </div>
                </div>
                <div class="window-content" id="terminal-content">
                    <div id="terminal-output"> <p>NetGuard OS [Version 17.0]</p> <p>(c) 2025 CyberCore Initiative. All rights reserved.</p> <p>Type 'help' for a list of commands.</p> </div>
                    <div class="terminal-prompt-line"> <span class="terminal-prompt">></span> <input type="text" id="terminal-input" autocomplete="off" /> </div>
                </div>
                <div class="resize-handle"></div>
            </div>
            
            <div id="mail-window" class="window hidden">
                <div class="title-bar">
                    <span class="title-bar-text">üìß Secure Mail</span>
                    <div class="window-controls">
                        <button class="window-minimize" data-window="mail-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12H4"/></svg></button>
                        <button class="window-maximize" data-window="mail-window">
                            <svg class="icon-svg-small icon-maximize" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" /></svg>
                            <svg class="icon-svg-small icon-restore" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        </button>
                        <button class="window-close" data-window="mail-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                    </div>
                </div>
                <div class="window-content">
                    <div id="mail-sidebar"> <div class="mail-item active"> <div class="mail-item-sender">[CLASSIFIED]</div> <div class="mail-item-subject">URGENT: Mission Briefing</div> </div> </div>
                    <div id="mail-reader">
                        <div class="mail-header"> <h3>Subject: URGENT: Mission Briefing</h3> <p>From: [CLASSIFIED]</p> <p>To: Agent [YOU]</p> </div>
                        <div class="mail-body"> <p>Agent,</p> <br> <p>Welcome to the NetGuard Program. Our systems are under attack from an unknown entity.</p> <p>Your first priority is to secure our network, starting with the outer nodes. Our intel shows 'Local Server' is the first point of entry.</p> <br> <p>Use the **Core Builder** (‚öôÔ∏è) to design and deploy countermeasures. Check your component bay for available modules.</p> <p>Use the **Global Network** (üåç) to view all active nodes and deploy your build against them.</p> <br> <p>Do not fail. We are counting on you.</p> </div>
                    </div>
                </div>
                <div class="resize-handle"></div>
            </div>

            <div id="taskbar">
                <button id="start-btn">
                    <svg class="icon-svg-small" style="stroke: #000; margin: 0;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" />
                    </svg>
                </button>
                <button class="taskbar-icon" id="btn-workshop" data-window="workshop-window">‚öôÔ∏è</button>
                <button class="taskbar-icon" id="btn-network" data-window="network-window">üåç</button>
                <button class="taskbar-icon" id="btn-sys-mon" data-window="sys-mon-window">üìà</button>
                <button class="taskbar-icon" id="btn-appearance" data-window="appearance-window">üé®</button>
                <button class="taskbar-icon" id="btn-terminal" data-window="terminal-window">>_</button>
                <button class="taskbar-icon" id="btn-mail" data-window="mail-window">üìß</button>
                <div id="system-tray">
                    <div id="tray-icon-log" class="tray-icon">
                        <svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <div id="log-console">
            <div id="log-header">SYS-LOG // LIVE FEED</div>
            <div id="log-content"></div>
        </div>
    </div>
    
    <div id="context-menu" class="hidden">
        <ul>
            <li class="ctx-open" data-window="workshop-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>Open Core Builder</li>
            <li class="ctx-open" data-window="network-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" /></svg>Open Global Network</li>
            <li class="divider"></li>
            <li class="ctx-open" data-window="sys-mon-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>Open System Monitor</li>
            <li class="ctx-open" data-window="appearance-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>Open Appearance</li>
            <li class="ctx-open" data-window="terminal-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>Open Terminal</li>
            <li class="ctx-open" data-window="mail-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>Open Secure Mail</li>
            <li class="divider"></li>
            <li class="disabled">Shutdown...</li>
        </ul>
    </div>
    
    <div id="start-menu" class="hidden">
        <ul>
            <li class="start-menu-item" data-window="workshop-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>Core Builder</li>
            <li class="start-menu-item" data-window="network-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" /></svg>Global Network</li>
            <li class="start-menu-item" data-window="sys-mon-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>System Monitor</li>
            <li class="start-menu-item" data-window="appearance-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>Appearance</li>
            <li class="start-menu-item" data-window="terminal-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>Terminal</li>
            <li class="start-menu-item" data-window="mail-window"><svg class="icon-svg-small" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>Secure Mail</li>
            <li class="start-menu-item divider"></li>
            <li class="start-menu-item disabled">Shutdown...</li>
        </ul>
    </div>


    <script>
    /* * LAYER 1: THE ENGINE (JAVASCRIPT DATA & LOGIC)
     */
    
    // --- Audio Setup (v16) ---
    let audioContext;
    let ambientNodes = [];
    try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
    catch (e) { console.warn("Web Audio API is not supported."); }
    
    // v16: Ambient Sound Engine
    function startAmbientSound() {
        if (!audioContext || ambientNodes.length > 0) return;
        const humOsc = audioContext.createOscillator();
        const humGain = audioContext.createGain();
        humOsc.type = 'sine';
        humOsc.frequency.setValueAtTime(60, audioContext.currentTime);
        humGain.gain.setValueAtTime(0.006, audioContext.currentTime);
        humOsc.connect(humGain);
        humGain.connect(audioContext.destination);
        humOsc.start();

        const fanOsc = audioContext.createOscillator();
        const fanGain = audioContext.createGain();
        fanOsc.type = 'triangle';
        fanOsc.frequency.setValueAtTime(120, audioContext.currentTime);
        fanGain.gain.setValueAtTime(0.003, audioContext.currentTime);
        fanOsc.connect(fanGain);
        fanGain.connect(audioContext.destination);
        fanOsc.start();
        
        ambientNodes = [humOsc, humGain, fanOsc, fanGain];
    }
    
    // v16: Interactive Sound Engine
    function playSound(type) {  
        if (!audioContext) return;  
        const gainNode = audioContext.createGain();
        gainNode.connect(audioContext.destination);
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.2);

        let osc1 = audioContext.createOscillator();
        let osc2;
        osc1.connect(gainNode);

        switch(type) {
            case 'click':
                osc1.type = 'sine';
                osc1.frequency.setValueAtTime(1200, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.05);
                break;
            case 'place':
                osc1.type = 'sine';
                osc1.frequency.setValueAtTime(900, audioContext.currentTime);
                osc1.frequency.exponentialRampToValueAtTime(500, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.1);
                break;
            case 'remove':
                osc1.type = 'sawtooth';
                osc1.frequency.setValueAtTime(300, audioContext.currentTime);
                osc1.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.15);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.15);
                break;
            case 'error':
                osc1.type = 'sawtooth';
                osc1.frequency.setValueAtTime(150, audioContext.currentTime);
                osc2 = audioContext.createOscillator();
                osc2.type = 'sawtooth';
                osc2.frequency.setValueAtTime(157, audioContext.currentTime);
                osc2.connect(gainNode);
                osc2.start(audioContext.currentTime);
                osc2.stop(audioContext.currentTime + 0.2);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.2);
                break;
            case 'win':
                osc1.type = 'sine';
                osc1.frequency.setValueAtTime(800, audioContext.currentTime);
                osc2 = audioContext.createOscillator();
                osc2.type = 'sine';
                osc2.frequency.setValueAtTime(1200, audioContext.currentTime);
                osc2.connect(gainNode);
                const osc3 = audioContext.createOscillator();
                osc3.type = 'sine';
                osc3.frequency.setValueAtTime(1600, audioContext.currentTime + 0.07);
                osc3.connect(gainNode);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.3);
                osc2.start(audioContext.currentTime);
                osc3.start(audioContext.currentTime + 0.07);
                osc2.stop(audioContext.currentTime + 0.3);
                osc3.stop(audioContext.currentTime + 0.3);
                break;
        }
        osc1.start(audioContext.currentTime);
        osc1.stop(audioContext.currentTime + 0.3);
    }

    // --- Log Console Function ---
    const logContent = document.getElementById('log-content');
    function log(message, type = 'info') {
        const p = document.createElement('p');
        p.className = `log-${type}`;
        p.textContent = `> ${message}`;
        logContent.prepend(p);
        if (logContent.children.length > 100) {
            logContent.removeChild(logContent.lastChild);
        }
        if (type === 'error' || type === 'warning') {
            const logIcon = document.getElementById('tray-icon-log');
            logIcon.classList.add('alerting');
            if (type === 'error') {
                logIcon.style.backgroundColor = 'var(--color-danger)';
            } else if (!logIcon.style.backgroundColor) {  
                logIcon.style.backgroundColor = 'var(--color-warning)';
            }
        }
    }

    // --- Module & Challenge Databases ---
    const MODULE_DB = {
        cpu_core: { name: 'CPU Core', shape: [[1]], stats: { Detection: 5, Memory: 1 }, color: '#f0f', synergy: null },
        scanner_v1: { name: 'Scanner v1', shape: [[1], [1]], stats: { Detection: 15, Memory: 2 }, color: '#0ff', synergy: { type: 'firewall_v', bonus: { Detection: 5 } } },
        firewall_v1: { name: 'Firewall v1', shape: [[1, 1]], stats: { Firewall: 10, Memory: 1 }, color: '#f80', synergy: { type: 'firewall_v', bonus: { Firewall: 5 } } },
        firewall_v2: { name: 'Firewall v2', shape: [[1, 1], [1, 1]], stats: { Firewall: 30, Memory: 4 }, color: '#f00', synergy: { type: 'firewall_v', bonus: { Firewall: 10 } } }
    };
    const CHALLENGE_DB = {
        node_1: { name: "Local Server", requirements: { Detection: 15 }, constraints: { maxMemory: 5 }, reward: "firewall_v2", pos: { x: 20, y: 50 } },
        node_2: { name: "Traffic Control", requirements: { Detection: 20, Firewall: 25 }, constraints: { maxMemory: 8 }, reward: null, pos: { x: 50, y: 30 } },
        node_3: { name: "Data Hub", requirements: { Detection: 30, Firewall: 35, Memory: 10 }, constraints: { maxMemory: 12 }, reward: "scanner_v2", pos: { x: 80, y: 60 } }
    };
    const MAX_STATS = { Detection: 100, Firewall: 100, Memory: 20 };

    // --- Game State ---
    let gridState = Array(8).fill(null).map(() => Array(8).fill(null));
    let playerInventory = { scanner_v1: 1, firewall_v1: 1, firewall_v2: 0 };
    let nodeStatus = { node_1: "UNLOCKED", node_2: "LOCKED", node_3: "LOCKED" };
    let currentStats = { Detection: 0, Firewall: 0, Memory: 0 };
    let currentBonusStats = { Detection: 0, Firewall: 0, Memory: 0 };
    let selectedModule = null;
    let previousStats = {};
    let currentChallengeId = null;  
    let currentZIndex = 100;  
    
    // v17: Window state now includes restore data
    let openWindows = {  
        "workshop-window":   { status: 'closed', z: 100, isMaximized: false, restore: {x:0, y:0, w:0, h:0} },
        "network-window":    { status: 'closed', z: 100, isMaximized: false, restore: {x:0, y:0, w:0, h:0} },
        "sys-mon-window":    { status: 'closed', z: 100, isMaximized: false, restore: {x:0, y:0, w:0, h:0} },
        "appearance-window": { status: 'closed', z: 100, isMaximized: false, restore: {x:0, y:0, w:0, h:0} },
        "terminal-window":   { status: 'closed', z: 100, isMaximized: false, restore: {x:0, y:0, w:0, h:0} },
        "mail-window":       { status: 'closed', z: 100, isMaximized: false, restore: {x:0, y:0, w:0, h:0} }
    };
    let currentTheme = 'wallpaper-default';
    
    let bootLogEl = document.getElementById('boot-log');
    let loginPromptEl = document.getElementById('login-prompt');
    const bootSequence = [
        "NETGUARD_OS v17.0 LOADING...", // v17
        "INITIALIZING KERNEL... [OK]",
        "MOUNTING SYS-LOG... [OK]",
        "MOUNTING CORE_BUILDER.APP... [OK]",
        "MOUNTING GLOBAL_NETWORK.APP... [OK]",
        "MOUNTING SYS_MONITOR.APP... [OK]",  
        "MOUNTING APPEARANCE.APP... [OK]",  
        "MOUNTING TERMINAL.APP... [OK]",  
        "MOUNTING SECURE_MAIL.APP... [OK]",
        "LOADING WINDOW MANAGER v2.0... [OK]", // v17
        "CHECKING FIREWALL STATUS... [SECURE]",
        "AWAITING USER AUTHENTICATION...",
    ];


    // --- Engine Functions ---
    
    function startBootSequence() {
        let i = 0;
        function nextLine() {
            if (i < bootSequence.length) {
                const p = document.createElement('p');
                p.textContent = bootSequence[i];
                bootLogEl.appendChild(p);
                i++;
                setTimeout(nextLine, 150 + Math.random() * 150);
            } else {
                loginPromptEl.classList.remove('hidden');
                document.addEventListener('keydown', login, { once: true });
            }
        }
        nextLine();
    }
    
    function login() {
        document.getElementById('boot-screen').classList.add('hidden');
        document.getElementById('desktop-container').classList.remove('hidden');
        startAmbientSound();
        
        log('Initializing Net Guard OS v17.0...', 'system');
        const gridContainer = document.getElementById('grid-container');
        const gridLabelsX = document.querySelector('.grid-labels-x');
        const gridLabelsY = document.querySelector('.grid-labels-y');

        for (let y = 0; y < 8; y++) {
            const yLabel = document.createElement('span'); yLabel.textContent = y;
            gridLabelsY.appendChild(yLabel);
            const xLabel = document.createElement('span'); xLabel.textContent = y;
            gridLabelsX.appendChild(xLabel);
            for (let x = 0; x < 8; x++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.x = x; cell.dataset.y = y;
                cell.addEventListener('click', () => handleCellClick(x, y));
                cell.addEventListener('contextmenu', (e) => handleCellRemove(e, x, y));
                cell.addEventListener('mouseenter', () => handlePreview(x, y));
                cell.addEventListener('mouseleave', clearPreview);
                gridContainer.appendChild(cell);
            }
        }
        
        document.querySelectorAll('.taskbar-icon').forEach(icon => {
            icon.addEventListener('click', () => handleTaskbarClick(icon.dataset.window));
        });
        
        document.querySelectorAll('.desktop-icon').forEach(icon => {
            icon.addEventListener('dblclick', () => openWindow(icon.dataset.window));
        });

        // v17: UPDATED Window event listener setup
        document.querySelectorAll('.window').forEach(windowEl => {
            const titleBar = windowEl.querySelector('.title-bar');
            const closeBtn = windowEl.querySelector('.window-close');
            const minBtn = windowEl.querySelector('.window-minimize');
            const maxBtn = windowEl.querySelector('.window-maximize'); // v17 NEW
            const resizeHandle = windowEl.querySelector('.resize-handle');
            
            closeBtn.addEventListener('click', () => closeWindow(closeBtn.dataset.window));
            minBtn.addEventListener('click', () => minimizeWindow(minBtn.dataset.window));
            maxBtn.addEventListener('click', () => toggleMaximize(maxBtn.dataset.window)); // v17 NEW
            
            // v17: Add dblclick to title bar to maximize
            titleBar.addEventListener('dblclick', (e) => {
                if (e.target.closest('.window-controls')) return; // Don't trigger on buttons
                toggleMaximize(windowEl.id);
            });
            
            makeWindowDraggable(windowEl, titleBar);
            if(resizeHandle) {
                makeWindowResizable(windowEl, resizeHandle);  
            }
            
            windowEl.addEventListener('mousedown', () => bringWindowToFront(windowEl.id));
        });
        
        const desktop = document.getElementById('main-desktop-area');
        const contextMenu = document.getElementById('context-menu');
        desktop.addEventListener('contextmenu', (e) => {
            hideAllMenus();
            if (e.target.id === 'main-desktop-area' || e.target.closest('.desktop-icon-area')) {
                e.preventDefault();
                contextMenu.style.top = `${e.clientY}px`;
                contextMenu.style.left = `${e.clientX}px`;
                contextMenu.classList.add('visible');
            }
        });
        document.addEventListener('click', (e) => {  
            if (!e.target.closest('#context-menu')) contextMenu.classList.remove('visible');
            if (!e.target.closest('#start-menu') && !e.target.closest('#start-btn')) {
                document.getElementById('start-menu').classList.remove('visible');
            }
        });
        document.querySelectorAll('.ctx-open').forEach(item => {
            item.addEventListener('click', () => openWindow(item.dataset.window));
        });

        document.getElementById('details-close-btn').addEventListener('click', hideChallengeDetails);
        document.getElementById('details-try-btn').addEventListener('click', () => {
            if (currentChallengeId) handleTryChallenge(currentChallengeId);
        });
        
        document.getElementById('clear-grid-btn').addEventListener('click', handleClearGrid);
        
        updateClock();
        setInterval(updateClock, 1000);
        
        document.getElementById('tray-icon-log').addEventListener('click', () => {
            const logIcon = document.getElementById('tray-icon-log');
            logIcon.classList.remove('alerting');
            logIcon.style.backgroundColor = '';  
            log('Log acknowledged. Alerts cleared.', 'system');
        });
        
        document.getElementById('start-btn').addEventListener('click', () => {
             hideAllMenus();
             document.getElementById('start-menu').classList.toggle('visible');
        });
        document.querySelectorAll('.start-menu-item').forEach(item => {
            if(!item.classList.contains('disabled')) {
                item.addEventListener('click', () => {
                    openWindow(item.dataset.window);
                    document.getElementById('start-menu').classList.remove('visible');
                });
            }
        });
        
        document.getElementById('btn-theme-default').addEventListener('click', () => changeTheme('wallpaper-default'));
        document.getElementById('btn-theme-matrix').addEventListener('click', () => changeTheme('wallpaper-matrix'));
        
        document.getElementById('terminal-input').addEventListener('keydown', handleTerminalInput);
        document.getElementById('terminal-content').addEventListener('click', () => {
             document.getElementById('terminal-input').focus();
        });

        const cpuInstanceId = 'cpu_core_id';
        gridState[4][4] = { moduleId: 'cpu_core', instanceId: cpuInstanceId };
        log('Central CPU Core online at [4, 4].', 'success');
        
        recalculateStats();
        updateUI();
        previousStats = { ...currentStats };
        log('System stats calibrated. Ready.', 'system');
        openWindow('mail-window');
    }
    
    function updateClock() {
        const now = new Date();
        document.getElementById('clock-widget').textContent = now.toLocaleTimeString('en-US', { hour12: false });
    }
    
    // ===================================================================
    // v17: START OF UPDATED WINDOW MANAGEMENT LOGIC
    // ===================================================================
    
    function makeWindowDraggable(windowEl, titleBar) {
        let initialX, initialY, initialMouseX, initialMouseY;
        titleBar.addEventListener('mousedown', (e) => {
            // v17: Check if window is maximized before dragging
            if (openWindows[windowEl.id].isMaximized) {
                return;
            }
            if (e.target.classList.contains('window-close') || e.target.classList.contains('window-minimize') || e.target.classList.contains('window-maximize')) {
                return;
            }
            bringWindowToFront(windowEl.id);
            initialX = windowEl.offsetLeft;
            initialY = windowEl.offsetTop;
            initialMouseX = e.clientX;
            initialMouseY = e.clientY;
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('mouseup', onDragUp);
        });
        function onDragMove(e) {
            const dx = e.clientX - initialMouseX;
            const dy = e.clientY - initialMouseY;
            windowEl.style.left = `${initialX + dx}px`;
            windowEl.style.top = `${initialY + dy}px`;
        }
        function onDragUp(e) {
            document.removeEventListener('mousemove', onDragMove);
            document.removeEventListener('mouseup', onDragUp);
        }
    }
    
    function makeWindowResizable(windowEl, resizeHandle) {
        let initialW, initialH, initialMouseX, initialMouseY;
        
        resizeHandle.addEventListener('mousedown', (e) => {
            // v17: Check if window is maximized before resizing
            if (openWindows[windowEl.id].isMaximized) {
                return;
            }
            e.stopPropagation();
            bringWindowToFront(windowEl.id);
            
            initialW = windowEl.offsetWidth;
            initialH = windowEl.offsetHeight;
            initialMouseX = e.clientX;
            initialMouseY = e.clientY;

            document.addEventListener('mousemove', onResizeMove);
            document.addEventListener('mouseup', onResizeUp);
        });
        
        function onResizeMove(e) {
            const dw = e.clientX - initialMouseX;
            const dh = e.clientY - initialMouseY;
            windowEl.style.width = `${initialW + dw}px`;
            windowEl.style.height = `${initialH + dh}px`;
        }
        
        function onResizeUp() {
            document.removeEventListener('mousemove', onResizeMove);
            document.removeEventListener('mouseup', onResizeUp);
        }
    }
    
    // v17: NEW Maximize/Restore Function
    function toggleMaximize(windowId) {
        const windowEl = document.getElementById(windowId);
        const state = openWindows[windowId];
        
        if (state.isMaximized) {
            // RESTORE
            windowEl.classList.remove('maximized');
            // Restore old position and size
            windowEl.style.top = state.restore.y;
            windowEl.style.left = state.restore.x;
            windowEl.style.width = state.restore.w;
            windowEl.style.height = state.restore.h;
            
            state.isMaximized = false;
            log(`Restored window '${windowId}'`, 'system');
        } else {
            // MAXIMIZE
            // Save current position and size
            state.restore = {
                y: windowEl.style.top || `${windowEl.offsetTop}px`,
                x: windowEl.style.left || `${windowEl.offsetLeft}px`,
                w: windowEl.style.width || `${windowEl.offsetWidth}px`,
                h: windowEl.style.height || `${windowEl.offsetHeight}px`
            };
            
            windowEl.classList.add('maximized');
            state.isMaximized = true;
            log(`Maximized window '${windowId}'`, 'system');
        }
        playSound('click');
    }

    function openWindow(windowId) {
        const windowEl = document.getElementById(windowId);
        const taskbarIcon = document.querySelector(`.taskbar-icon[data-window="${windowId}"]`);
        
        // v17: If restoring from maximized, don't reset position
        if (openWindows[windowId].isMaximized) {
             windowEl.classList.remove('hidden', 'minimized');
        } else {
            windowEl.classList.remove('hidden', 'minimized');
            // Restore position from state if it exists (for non-maximized windows)
            if(openWindows[windowId].restore.x) {
                windowEl.style.top = openWindows[windowId].restore.y;
                windowEl.style.left = openWindows[windowId].restore.x;
            }
        }
        
        taskbarIcon.classList.add('active');
        taskbarIcon.classList.remove('minimized');
        bringWindowToFront(windowId);
        log(`Opened window '${windowId}'`, 'system');
        playSound('click');
        
        openWindows[windowId].status = 'open';
        updateUI();
    }
    
    function closeWindow(windowId) {
        const windowEl = document.getElementById(windowId);
        const taskbarIcon = document.querySelector(`.taskbar-icon[data-window="${windowId}"]`);
        
        // v17: If closing a maximized window, restore it first silently
        if (openWindows[windowId].isMaximized) {
            toggleMaximize(windowId); // Restore it
        }
        
        windowEl.classList.add('hidden');
        windowEl.classList.remove('minimized');
        taskbarIcon.classList.remove('active', 'minimized');
        log(`Closed window '${windowId}'`, 'system');
        playSound('click');
        
        openWindows[windowId].status = 'closed';
    }
    
    function minimizeWindow(windowId) {
        const windowEl = document.getElementById(windowId);
        const taskbarIcon = document.querySelector(`.taskbar-icon[data-window="${windowId}"]`);
        windowEl.classList.add('hidden', 'minimized');
        taskbarIcon.classList.add('active', 'minimized');
        log(`Minimized window '${windowId}'`, 'system');
        playSound('click');
        
        openWindows[windowId].status = 'minimized';
    }
    
    function bringWindowToFront(windowId) {
        document.querySelectorAll('.window').forEach(w => {
            w.classList.add('inactive');
        });
        
        const windowEl = document.getElementById(windowId);
        windowEl.classList.remove('inactive');
        currentZIndex++;
        windowEl.style.zIndex = currentZIndex;
        openWindows[windowId].z = currentZIndex;
    }
    
    function handleTaskbarClick(windowId) {
        const windowEl = document.getElementById(windowId);
        const state = openWindows[windowId];
        const isActive = (windowEl.style.zIndex == currentZIndex) && (state.status === 'open');

        if (state.status === 'closed') {
            openWindow(windowId);
        } else if (state.status === 'minimized') {
            openWindow(windowId);
        } else if (isActive) {
            minimizeWindow(windowId);
        } else {
            bringWindowToFront(windowId);
            playSound('click');
        }
    }
    
    function hideAllMenus() {
        document.getElementById('context-menu').classList.remove('visible');
        document.getElementById('start-menu').classList.remove('visible');
    }
    
    // ===================================================================
    // v17: END OF UPDATED WINDOW MANAGEMENT LOGIC
    // ===================================================================
    
    function changeTheme(themeName) {
        const canvas = document.getElementById('matrix-canvas');
        const desktop = document.getElementById('main-desktop-area');
        
        if (themeName === 'wallpaper-matrix') {
            desktop.className = 'wallpaper-matrix';
            canvas.style.display = 'block';
            startMatrixRain();
        } else {
            desktop.className = 'wallpaper-default';
            canvas.style.display = 'none';
        }
        
        currentTheme = themeName;
        updateThemeButtons();
        log(`Theme changed to '${themeName}'`, 'info');
    }
    function updateThemeButtons() {
        document.querySelectorAll('.theme-button').forEach(btn => btn.classList.remove('active'));
        if (currentTheme === 'wallpaper-default') {
            document.getElementById('btn-theme-default').classList.add('active');
        } else if (currentTheme === 'wallpaper-matrix') {
            document.getElementById('btn-theme-matrix').classList.add('active');
        }
    }
    
    const terminalOutput = document.getElementById('terminal-output');
    const terminalInput = document.getElementById('terminal-input');
    function handleTerminalInput(e) {
        if (e.key !== 'Enter') return;
        const command = terminalInput.value.trim().toLowerCase();
        if (command === '') return;
        terminalPrint(`> ${command}`);
        parseCommand(command);
        terminalInput.value = '';
    }
    
    function terminalPrint(message, type = 'log-success') {
        const p = document.createElement('p');
        p.className = type;
        p.textContent = message;
        terminalOutput.appendChild(p);
        terminalOutput.scrollTop = terminalOutput.scrollHeight;
    }
    
    function parseCommand(command) {
        const args = command.split(' ');
        const baseCmd = args[0];
        
        switch(baseCmd) {
            case 'help':
                terminalPrint("Available Commands:\n  help - Show this message\n  status - View current system stats\n  scan <node> - Scan a network node (e.g., 'scan node_1')\n  open <app> - Open an application (e.g., 'open builder')\n  clear - Clear the terminal screen", 'log-info');
                break;
            case 'status':
                recalculateStats();
                terminalPrint("System Status:\n  ‚ö° Detection: " + currentStats.Detection + "\n  üõ°Ô∏è Firewall:  " + currentStats.Firewall + "\n  üíæ Memory:    " + currentStats.Memory, 'log-info');
                break;
            case 'scan':
                const nodeKey = args[1];
                if (nodeKey && CHALLENGE_DB[nodeKey]) {
                    const node = CHALLENGE_DB[nodeKey];
                    const status = nodeStatus[nodeKey];
                    terminalPrint(`Scanning '${node.name}' (${nodeKey})...\nStatus: ${status}\nRequirements: ${JSON.stringify(node.requirements)}\nConstraints: ${JSON.stringify(node.constraints)}`, 'log-warning');
                } else {
                    terminalPrint("Error: Node not found. Usage: scan <node_id>", 'log-error');
                }
                break;
            case 'open':
                const appName = args[1];
                let windowId = '';
                if (appName === 'builder') windowId = 'workshop-window';
                else if (appName === 'network') windowId = 'network-window';
                else if (appName === 'monitor') windowId = 'sys-mon-window';
                else if (appName === 'theme' || appName === 'appearance') windowId = 'appearance-window';
                else if (appName === 'mail') windowId = 'mail-window';
                else if (appName === 'terminal') windowId = 'terminal-window';
                
                if (windowId && openWindows[windowId]) {
                    openWindow(windowId);
                    terminalPrint(`Opening '${appName}'...`, 'log-success');
                } else {
                    terminalPrint(`Error: Application '${appName}' not found.`, 'log-error');
                }
                break;
            case 'clear':
                terminalOutput.innerHTML = '';
                break;
            default:
                terminalPrint(`Command not found: '${command}'. Type 'help' for list.`, 'log-error');
        }
    }
    
    function handleClearGrid() {
        if (!confirm("Are you sure you want to clear the grid? All modules will be returned to inventory.")) { return; }
        log('[SYSTEM] Grid clear initiated...', 'system');
        playSound('remove');
        gridState = Array(8).fill(null).map(() => Array(8).fill(null));
        gridState[4][4] = { moduleId: 'cpu_core', instanceId: 'cpu_core_id' };  
        playerInventory = { scanner_v1: 1, firewall_v1: 1, firewall_v2: 0 };
        if(nodeStatus.node_1 === 'CLEARED') playerInventory.firewall_v2++;
        log(`[SUCCESS] Grid cleared. Modules reset to default bay.`, 'success');
        recalculateStats();
        updateUI();
    }

    function recalculateStats() {
        previousStats = { ...currentStats };
        let baseStats = { Detection: 0, Firewall: 0, Memory: 0 };
        let bonusStats = { Detection: 0, Firewall: 0, Memory: 0 };
        const countedModules = new Set();  
        const synergyInstances = new Set();  
        for (let y = 0; y < 8; y++) {
            for (let x = 0; x < 8; x++) {
                const cell = gridState[y][x];
                if (cell && !countedModules.has(cell.instanceId)) {
                    const module = MODULE_DB[cell.moduleId];
                    Object.keys(module.stats).forEach(stat => {
                        if (baseStats.hasOwnProperty(stat)) baseStats[stat] += module.stats[stat];
                    });
                    countedModules.add(cell.instanceId);
                }
            }
        }
        for (let y = 0; y < 8; y++) {
            for (let x = 0; x < 8; x++) {
                const cell = gridState[y][x];
                if (cell && !synergyInstances.has(cell.instanceId)) {
                    synergyInstances.add(cell.instanceId);
                    const module = MODULE_DB[cell.moduleId];
                    if (!module.synergy) continue;  
                    const synergyType = module.synergy.type;
                    const synergyBonus = module.synergy.bonus;
                    let hasFoundSynergy = false;
                    const moduleCells = [];
                    for (let iy = 0; iy < 8; iy++) {
                        for (let ix = 0; ix < 8; ix++) {
                            if (gridState[iy][ix] && gridState[iy][ix].instanceId === cell.instanceId) {
                                moduleCells.push({ y: iy, x: ix });
                            }
                        }
                    }
                    for (const mCell of moduleCells) {
                        const neighbors = [[0, 1], [0, -1], [1, 0], [-1, 0]];
                        for (const [dy, dx] of neighbors) {
                            const ny = mCell.y + dy;
                            const nx = mCell.x + dx;
                            if (ny >= 0 && ny < 8 && nx >= 0 && nx < 8) {
                                const neighbor = gridState[ny][nx];
                                if (neighbor && neighbor.instanceId !== cell.instanceId && neighbor.moduleId.includes(synergyType)) {
                                    hasFoundSynergy = true;
                                    break;
                                }
                            }
                        }
                        if (hasFoundSynergy) break;
                    }
                    if (hasFoundSynergy) {
                        let bonusAdded = false;
                        Object.keys(synergyBonus).forEach(stat => {
                            if (bonusStats.hasOwnProperty(stat)) {
                                bonusStats[stat] += synergyBonus[stat];
                                bonusAdded = true;
                            }
                        });
                        if(bonusAdded && !previousStats[Object.keys(synergyBonus)[0]]) {
                             log(`Synergy detected: '${module.name}' activated bonus.`, 'warning');
                        }
                    }
                }
            }
        }
        currentStats.Detection = baseStats.Detection + bonusStats.Detection;
        currentStats.Firewall = baseStats.Firewall + bonusStats.Firewall;
        currentStats.Memory = baseStats.Memory + bonusStats.Memory;
        currentBonusStats = bonusStats;  
    }
    function canPlacePart(moduleId, gridX, gridY) {
        const module = MODULE_DB[moduleId];
        const shape = module.shape;
        for (let dy = 0; dy < shape.length; dy++) {
            for (let dx = 0; dx < shape[dy].length; dx++) {
                if (shape[dy][dx] === 1) {  
                    const targetX = gridX + dx;
                    const targetY = gridY + dy;
                    if (targetX < 0 || targetX >= 8 || targetY < 0 || targetY >= 8) return false;  
                    if (gridState[targetY][targetX] !== null) return false;
                }
            }
        }
        return true;
    }
    function placeModule(moduleId, gridX, gridY) {
        const module = MODULE_DB[moduleId];
        const shape = module.shape;
        const instanceId = Date.now();  
        for (let dy = 0; dy < shape.length; dy++) {
            for (let dx = 0; dx < shape[dy].length; dx++) {
                if (shape[dy][dx] === 1) {
                    const targetX = gridX + dx;
                    const targetY = gridY + dy;
                    gridState[targetY][targetX] = { moduleId, instanceId };
                }
            }
        }
        playerInventory[moduleId]--;
    }
    function removeModule(instanceId, moduleId) {
        for (let y = 0; y < 8; y++) {
            for (let x = 0; x < 8; x++) {
                const cell = gridState[y][x];
                if (cell && cell.instanceId === instanceId) {
                    gridState[y][x] = null;
                }
            }
        }
        playerInventory[moduleId]++;
    }
    
    function handlePreview(x, y) {
        if (!selectedModule) return;
        const moduleId = selectedModule;
        const module = MODULE_DB[moduleId];
        const shape = module.shape;
        const isValid = canPlacePart(moduleId, x, y);
        for (let dy = 0; dy < shape.length; dy++) {
            for (let dx = 0; dx < shape[dy].length; dx++) {
                if (shape[dy][dx] === 1) {
                    const targetX = x + dx;
                    const targetY = y + dy;
                    if (targetX >= 0 && targetX < 8 && targetY >= 0 && targetY < 8) {
                        const cellDiv = document.querySelector(`.grid-cell[data-x="${targetX}"][data-y="${targetY}"]`);
                        if (cellDiv) {
                            cellDiv.classList.add(isValid ? 'preview-valid' : 'preview-invalid');
                        }
                    }
                }
            }
        }
    }
    function clearPreview() {
        document.querySelectorAll('.grid-cell').forEach(cell => {
            cell.classList.remove('preview-valid', 'preview-invalid');
        });
    }

    // --- Event Handlers (with Audio & Logs) ---
    function handleCellClick(x, y) {  
        if (!selectedModule) return;
        const moduleId = selectedModule;
        if (canPlacePart(moduleId, x, y)) {
            placeModule(moduleId, x, y);
            log(`[SUCCESS] Placed '${MODULE_DB[moduleId].name}' at [${x}, ${y}].`, 'success');
            selectedModule = null;
            recalculateStats();
            updateUI();  
            playSound('place');
        } else {
            log(`[ERROR] Placement at [${x}, ${y}] failed: Overlap or out-of-bounds.`, 'error');
            playSound('error');
        }
    }
    function handleCellRemove(e, x, y) {  
        e.preventDefault();  
        const cell = gridState[y][x];
        if (!cell) return;
        if (cell.moduleId === 'cpu_core') {
            log(`[ERROR] Cannot remove protected module 'CPU Core'.`, 'error');
            playSound('error');
            return;
        }
        const moduleName = MODULE_DB[cell.moduleId].name;
        removeModule(cell.instanceId, cell.moduleId);
        log(`[INFO] Removed '${moduleName}' from grid. Module returned to inventory.`, 'info');
        recalculateStats();
        updateUI();
        playSound('remove');
    }
    function handleInventoryClick(moduleId) {  
        if (playerInventory[moduleId] <= 0) return;
        selectedModule = (selectedModule === moduleId) ? null : moduleId;
        if (selectedModule) {
            log(`[INFO] Selected '${MODULE_DB[moduleId].name}' from inventory.`, 'info');
        } else {
            log(`[INFO] Deselected module.`, 'info');
        }
        playSound('click');
        updateInventory();  
    }
    function handleTryChallenge(nodeId) {  
        const challenge = CHALLENGE_DB[nodeId];
        log(`[INFO] Attempting challenge '${challenge.name}'...`, 'info');
        let isSuccess = true;
        let failMessages = [];
        let constraintViolations = [];

        Object.keys(challenge.requirements).forEach(stat => {
            const required = challenge.requirements[stat];
            const current = currentStats[stat] || 0;
            if (current < required) {
                isSuccess = false;
                failMessages.push(`- ${stat}: ${current} / ${required} (REQUIRED)`);
            }
        });
        const constraints = challenge.constraints || {};
        if (constraints.maxMemory && currentStats.Memory > constraints.maxMemory) {
            isSuccess = false;
            constraintViolations.push(`- Memory: ${currentStats.Memory} / ${constraints.maxMemory} (MAX)`);
        }

        if (isSuccess) {
            let rewardMsg = "No reward for this node.";
            if (challenge.reward) {
                if (!playerInventory.hasOwnProperty(challenge.reward)) playerInventory[challenge.reward] = 0;
                playerInventory[challenge.reward]++;
                rewardMsg = `Reward: 1x ${MODULE_DB[challenge.reward].name}`;
            }
            log(`[SUCCESS] Challenge '${challenge.name}' CLEARED. ${rewardMsg}`, 'success');
            playSound('win');
            nodeStatus[nodeId] = "CLEARED";
            if (nodeId === 'node_1' && nodeStatus.node_2 === 'LOCKED') {
                nodeStatus.node_2 = 'UNLOCKED';
                log(`[SYSTEM] New target detected: 'Traffic Control' node is now UNLOCKED.`, 'warning');
            }
            if (nodeId === 'node_2' && nodeStatus.node_3 === 'LOCKED') {
                nodeStatus.node_3 = 'UNLOCKED';
                log(`[SYSTEM] New target detected: 'Data Hub' node is now UNLOCKED.`, 'warning');
            }
        } else {
            let alertMsg = ``;
            if (failMessages.length > 0) alertMsg += `REQS NOT MET: ${failMessages.join(', ')}`;
            if (constraintViolations.length > 0) alertMsg += ` CONSTRAINTS VIOLATED: ${constraintViolations.join(', ')}`;
            log(`[ERROR] Challenge '${challenge.name}' FAILED. ${alertMsg}`, 'error');
            playSound('error');
        }
        updateNetwork();
        hideChallengeDetails();
    }
    function showChallengeDetails(nodeId) {  
        currentChallengeId = nodeId;
        const challenge = CHALLENGE_DB[nodeId];
        const status = nodeStatus[nodeId];
        document.getElementById('details-title').textContent = `// NODE: ${challenge.name}`;
        const reqsList = document.getElementById('details-reqs');
        reqsList.innerHTML = '';
        Object.keys(challenge.requirements).forEach(stat => {
            const req = challenge.requirements[stat];
            const current = currentStats[stat] || 0;
            const li = document.createElement('li');
            li.textContent = `${stat}: ${current} / ${req}`;
            li.style.color = (current >= req) ? 'var(--color-primary)' : 'var(--color-danger)';
            reqsList.appendChild(li);
        });
        const consList = document.getElementById('details-cons');
        consList.innerHTML = '';
        const constraints = challenge.constraints || {};
        Object.keys(constraints).forEach(con => {
            const req = constraints[con];
            let current, pass;
            if (con === 'maxMemory') {
                current = currentStats.Memory;
                pass = (current <= req);
                consList.innerHTML += `<li style="color:${pass ? 'var(--color-primary)' : 'var(--color-danger)'}">Max Memory: ${current} / ${req}</li>`;
            }
        });
        if (consList.innerHTML === '') consList.innerHTML = '<li>None</li>';
        const tryBtn = document.getElementById('details-try-btn');
        tryBtn.disabled = (status !== 'UNLOCKED');
        if(status === 'CLEARED') tryBtn.textContent = 'NODE SECURED';
        else tryBtn.textContent = 'ATTEMPT HACK';
        document.getElementById('challenge-details-panel').classList.add('visible');
    }
    function hideChallengeDetails() {  
        currentChallengeId = null;
        document.getElementById('challenge-details-panel').classList.remove('visible');
    }

    // --- Global UI Update Function ---
    function updateUI() {
        Object.keys(openWindows).forEach(windowId => {
            const state = openWindows[windowId];
            if(state.status === 'open') {
                switch(windowId) {
                    case 'workshop-window':
                        updateGrid();
                        updateInventory();
                        updateDashboard();
                        updateSystemMonitor();
                        break;
                    case 'network-window':
                        updateNetwork();  
                        break;
                    case 'sys-mon-window':
                        updateSystemMonitor();
                        break;
                    case 'appearance-window':
                        updateThemeButtons();
                        break;
                }
            }
        });
        
        if(openWindows['workshop-window'].status !== 'open') {
            updateInventory();  
        }
    }


    function updateGrid() {  
        for (let y = 0; y < 8; y++) {
            for (let x = 0; x < 8; x++) {
                const cellDiv = document.querySelector(`.grid-cell[data-x="${x}"][data-y="${y}"]`);
                const cellData = gridState[y][x];  
                cellDiv.className = 'grid-cell';  
                cellDiv.style.backgroundColor = '';  
                if (cellData) {
                    cellDiv.classList.add('module-occupied', `module-${cellData.moduleId}`, 'module-pop-in');
                }
            }
        }
    }
    function updateInventory() {  
        const inventoryContainer = document.getElementById('inventory');
        inventoryContainer.innerHTML = '';  
        Object.keys(playerInventory).forEach(moduleId => {  
            const count = playerInventory[moduleId];  
            const module = MODULE_DB[moduleId];
            if (!module) return;
            const itemBtn = document.createElement('button');
            itemBtn.className = 'inventory-item';
            if (count <= 0) itemBtn.disabled = true;
            if (selectedModule === moduleId) itemBtn.classList.add('selected');
            const shape = module.shape;
            const preview = document.createElement('div');
            preview.className = 'module-preview';
            preview.style.gridTemplateColumns = `repeat(${shape[0].length}, 8px)`;
            for (let y = 0; y < shape.length; y++) {
                for (let x = 0; x < shape[y].length; x++) {
                    const pCell = document.createElement('div');
                    pCell.className = 'preview-cell';
                    if (shape[y][x] === 1) pCell.classList.add('filled');
                    preview.appendChild(pCell);
                }
            }
            const text = document.createElement('span');
            text.innerHTML = `${module.name} <span>(x${count})</span>`;
            itemBtn.appendChild(preview);
            itemBtn.appendChild(text);
            itemBtn.addEventListener('click', () => handleInventoryClick(moduleId));
            inventoryContainer.appendChild(itemBtn);
        });
    }
    function updateDashboard() {  
        const dashboardContainer = document.getElementById('dashboard');
        dashboardContainer.innerHTML = '';  
        const createStatHtml = (name, icon, max) => {
            const total = currentStats[name] || 0;
            const bonus = currentBonusStats[name] || 0;
            const base = total - bonus;
            const percent = Math.min((total / max) * 100, 100);
            let flashClass = (previousStats[name] !== total) ? 'stat-updated' : '';
            let bonusHtml = (bonus > 0) ? `<span class="stat-bonus">+${bonus} ‚ú®</span>` : '';
            return `
                <div class="stat-item">
                    <div class="stat-label">
                        <span>${icon} ${name}</span>
                        <span class="stat-value ${flashClass}">${base}</span>
                        ${bonusHtml}
                    </div>
                    <div class="stat-bar-bg">
                        <div class="stat-bar-fill fill-${name}" style="width: ${percent}%;"></div>
                    </div>
                </div>
            `;
        };
        dashboardContainer.innerHTML =  
            createStatHtml('Detection', '‚ö°', MAX_STATS.Detection) +
            createStatHtml('Firewall', 'üõ°Ô∏è', MAX_STATS.Firewall) +
            createStatHtml('Memory', 'üíæ', MAX_STATS.Memory);
    }
    
    function updateSystemMonitor() {
        const memLabel = document.getElementById('mem-usage-label');
        const memBar = document.getElementById('mem-usage-bar');
        const memUsed = currentStats.Memory;
        const memMax = MAX_STATS.Memory;
        const percent = Math.min((memUsed / memMax) * 100, 100);
        
        memLabel.textContent = `${memUsed} / ${memMax}`;
        memBar.style.width = `${percent}%`;
    }
    
    function updateNetwork() {  
        const nodesContainer = document.getElementById('map-nodes');
        const linesContainer = document.getElementById('map-lines');
        nodesContainer.innerHTML = '';
        linesContainer.innerHTML = '';
        const nodeIds = Object.keys(CHALLENGE_DB);
        nodeIds.forEach(nodeId => {
            const challenge = CHALLENGE_DB[nodeId];
            const status = nodeStatus[nodeId];  
            const node = document.createElement('div');
            node.className = `map-node state-${status}`;
            node.style.left = `${challenge.pos.x}%`;
            node.style.top = `${challenge.pos.y}%`;
            node.dataset.name = challenge.name;  
            node.addEventListener('click', () => {
                playSound('click');
                showChallengeDetails(nodeId);
            });
            nodesContainer.appendChild(node);
        });
        for (let i = 0; i < nodeIds.length - 1; i++) {
            const nodeId1 = nodeIds[i];
            const nodeId2 = nodeIds[i+1];
            const n1 = CHALLENGE_DB[nodeId1];
            const n2 = CHALLENGE_DB[nodeId2];
            const status = (nodeStatus[nodeId2] === 'LOCKED') ? '' : 'unlocked';  
            const p1 = { x: n1.pos.x, y: n1.pos.y };
            const p2 = { x: n2.pos.x, y: n2.pos.y };
            const line = document.createElement('div');
            line.className = `connection-line ${status}`;
            const dx = p2.x - p1.x;
            const dy = p2.y - p1.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            line.style.left = `${p1.x}%`;
            line.style.top = `${p1.y}%`;
            line.style.width = `${dist}%`;
            line.style.transform = `rotate(${angle}deg)`;
            linesContainer.appendChild(line);
        }
    }
    
    // --- v15: Matrix Rain Animation ---
    let matrixCanvas, matrixCtx, matrixCols, matrixDrops, matrixInterval;
    let matrixRunning = false;
    const matrixChars = "NETGUARDOSCYBERCOREMATRIX0123456789";
    const matrixFontSize = 14;

    function startMatrixRain() {
        if (matrixRunning) return;
        matrixCanvas = document.getElementById('matrix-canvas');
        matrixCtx = matrixCanvas.getContext('2d');
        matrixCanvas.width = window.innerWidth;
        matrixCanvas.height = window.innerHeight;
        matrixCols = Math.floor(matrixCanvas.width / matrixFontSize);
        matrixDrops = [];
        for (let i = 0; i < matrixCols; i++) {
            matrixDrops[i] = 1;
        }
        if(matrixInterval) clearInterval(matrixInterval);
        matrixInterval = setInterval(drawMatrix, 50);
        matrixRunning = true;
    }

    function drawMatrix() {
        matrixCtx.fillStyle = "rgba(10, 14, 39, 0.05)";  
        matrixCtx.fillRect(0, 0, matrixCanvas.width, matrixCanvas.height);
        matrixCtx.fillStyle = "var(--color-primary)";
        matrixCtx.font = `${matrixFontSize}px monospace`;
        for (let i = 0; i < matrixDrops.length; i++) {
            const text = matrixChars.charAt(Math.floor(Math.random() * matrixChars.length));
            matrixCtx.fillText(text, i * matrixFontSize, matrixDrops[i] * matrixFontSize);
            if (matrixDrops[i] * matrixFontSize > matrixCanvas.height && Math.random() > 0.975) {
                matrixDrops[i] = 0;
            }
            matrixDrops[i]++;
        }
    }

    // --- Start the game ---
    document.addEventListener('DOMContentLoaded', startBootSequence);

    </script>
</body>
</html>